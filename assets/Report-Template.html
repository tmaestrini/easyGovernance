<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>easyGorvernance · <%= $Title %></title>
    <link rel="stylesheet" href="./styles/report.css">
</head>

<body>
    <div class="header-container">
        <div class="header-content">
            <div>
                <h1>easyGovernance · <%= $Title %></h1>
                <div class="header-subtitle">Overview of alignment of existing tenant settings along your baseline</div>
            </div>
            <div class="report-info">
                <div class="report-date">Report generated: <%= $Date_generated %></div>
                <div class="report-issuer">Issued by: <%= $Issuer%></div>
                <div class="tenant">Tenant: <%= $Tenant %></div>
            </div>
        </div>
    </div>

    <div class="content-container">
        <%= $summary_stats %>

        <div class="report-summary-container">
            <h2>Report summary</h2>

            <div class="report-summary">
                easyGovernance validates several configurations and resources along predefined configuration baselines
                for
                the Microsoft 365 tenant <code><%= $Tenant %></code> and dedicated services. Any configuration baseline is
                considered to reference the baseline suggestions from the <a
                    href="https://www.cisa.gov/resources-tools/services/secure-cloud-business-applications-scuba-project"
                    target="_blank" rel="noopener noreferer">Secure Cloud Business Applications (SCuBA) for Microsoft
                    365</a> by CISA and <a href="https://blueprint.oobe.com.au/blueprint/" target="_blank"
                    rel="noopener noreferer">the blueprint</a> by oobe. All configuration parameters that are used in
                the configuration baselines provide a standard and proven approach for Microsoft 365 but can be extended
                according to your needs.
            </div>
        </div>

        <div class="filter-container">
            <div class="filter-group">
                <label class="switch">
                    <input type="checkbox" id="toggleUnused" onchange="applyFilters()">
                    <span class="slider"></span>
                </label>
                <span class="filter-label">Show only baselines with failed results</span>
            </div>

            <div class="filter-group">
                <label class="switch">
                    <input type="checkbox" id="toggleHideFree" onchange="applyFilters()">
                    <span class="slider"></span>
                </label>
                <span class="filter-label">Hide failed results</span>
            </div>

            <div class="filter-group">
                <label class="switch">
                    <input type="checkbox" id="toggleHideTrial" onchange="applyFilters()">
                    <span class="slider"></span>
                </label>
                <span class="filter-label">Hide manual checks</span>
            </div>
        </div>

        <%= $result_details %>

        <div class="footer">
            <p>easyGovernance (2024 – 2025) · <a href="https://github.com/tmaestrini/easyGovernance" class="author-link" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                    fill="black">
                    <path
                        d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z" />
                </svg>
                https://github.com/tmaestrini/easyGovernance
            </a></p>
        </div>
    </div>

    <script>
        // Wait for document to be fully loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Attach event handlers
            document.getElementById('toggleUnused').onclick = function () { filterData(); };
            document.getElementById('toggleHideFree').onclick = function () { filterData(); };
            document.getElementById('toggleHideTrial').onclick = function () { filterData(); };
        });

        // The main filter function
        function filterData() {
            console.log('Filtering data...');

            // Get filter states
            let showOnlyUnused = document.getElementById('toggleUnused').checked;
            let hideFree = document.getElementById('toggleHideFree').checked;
            let hideTrial = document.getElementById('toggleHideTrial').checked;

            // Free licenses to filter
            let freeLicenses = [
                'windows store for business',
                'microsoft power automate free',
                'power virtual agents viral trial',
                'rights management adhoc'
            ];

            // Get the table and all data rows
            let table = document.getElementsByTagName('table')[0];
            if (!table) {
                console.error('Table not found!');
                return;
            }

            let tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.error('Table body not found!');
                return;
            }

            let rows = tbody.getElementsByTagName('tr');
            if (rows.length === 0) {
                console.error('No rows found in table!');
                return;
            }

            // Tracking totals
            let totalSum = 0;
            let usedSum = 0;
            let unusedSum = 0;
            let visibleCount = 0;

            // Process each row
            for (let i = 0; i < rows.length; i++) {
                let row = rows[i];
                let cells = row.getElementsByTagName('td');

                // Skip if we don't have enough cells
                if (cells.length < 5) continue;

                // Extract data from cells
                let licenseName = cells[0].textContent.trim().toLowerCase();
                let licenseType = cells[1].textContent.trim().toLowerCase();
                let totalLicenses = parseInt(cells[2].textContent) || 0;
                let usedLicenses = parseInt(cells[3].textContent) || 0;
                let unusedLicenses = parseInt(cells[4].textContent) || 0;

                // Apply filters
                let showRow = true;

                // Filter: Only show rows with unused licenses
                if (showOnlyUnused && unusedLicenses <= 0) {
                    showRow = false;
                }

                // Filter: Hide free licenses
                if (hideFree) {
                    for (let j = 0; j < freeLicenses.length; j++) {
                        if (licenseName.includes(freeLicenses[j])) {
                            showRow = false;
                            break;
                        }
                    }
                }

                // Filter: Hide trial licenses
                if (hideTrial && licenseType === 'trial') {
                    showRow = false;
                }

                // Apply visibility
                row.style.display = showRow ? '' : 'none';

                // Add to totals if row is visible
                if (showRow) {
                    totalSum += totalLicenses;
                    usedSum += usedLicenses;
                    unusedSum += unusedLicenses;
                    visibleCount++;
                }
            }

            // Update summary cards
            let totalLicensesValue = document.getElementById('totalLicensesValue');
            let totalSubscriptions = document.getElementById('totalSubscriptions');
            let usedLicensesValue = document.getElementById('usedLicensesValue');
            let usedPercentageElem = document.getElementById('usedPercentage');
            let unusedLicensesValue = document.getElementById('unusedLicensesValue');
            let unusedPercentageElem = document.getElementById('unusedPercentage');

            if (totalLicensesValue) totalLicensesValue.textContent = totalSum;
            if (totalSubscriptions) totalSubscriptions.textContent = 'Across ' + visibleCount + ' subscriptions';

            if (usedLicensesValue) usedLicensesValue.textContent = usedSum;
            let usedPercent = totalSum > 0 ? Math.round((usedSum / totalSum) * 100) : 0;
            if (usedPercentageElem) usedPercentageElem.textContent = usedPercent + '% of total';

            if (unusedLicensesValue) unusedLicensesValue.textContent = unusedSum;
            let unusedPercent = totalSum > 0 ? Math.round((unusedSum / totalSum) * 100) : 0;
            if (unusedPercentageElem) unusedPercentageElem.textContent = unusedPercent + '% of total';

            console.log('Filtering complete. Visible rows:', visibleCount);
        }

        // Define legacy functions to maintain backward compatibility
        function applyFilters() {
            filterData();
        }

        function filterUnusedLicenses() {
            filterData();
        }

        function exportToCSV() {
            // Headers for the CSV
            const headers = [
                'License SKU', 'Type', 'Total Licenses', 'Used Licenses', 'Unused licenses', 'Renewal/Expiratrion Date',
            ];

            // Data rows
            const rows = [
                headers.join(','),

                "'Microsoft Power Automate Free',,'Paid',,'10000',,'1',,'9999',,'',",
                "'Power Virtual Agents Viral Trial',,'Paid',,'10000',,'1',,'9999',,'',",
                "'Microsoft 365 E5 Developer (without Windows and Audio Conferencing)',,'Trial',,'25',,'17',,'8',,'2025-04-07',",
                "'Power Pages vTrial for Makers',,'Paid',,'10000',,'1',,'9999',,'',",
                "'Dynamics 365 Business Central for IWs',,'Paid',,'10000',,'1',,'9999',,'',",
                "'Microsoft Power Apps for Developer',,'Paid',,'10000',,'3',,'9997',,'',",
            ];

            // Create the CSV content
            const csvContent = "data:text/csv;charset=utf-8," + rows.join('\\r\\n');

            // Create a download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "license_usage_report_2025-03-05.csv");
            document.body.appendChild(link);

            // Trigger download
            link.click();

            document.body.removeChild(link);
        }
    </script>
</body>

</html>